<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PÃ©ndulo Invertido control</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: radial-gradient(circle, rgba(191,65,80,1) 0%, rgba(0,0,0,1) 100%);
      color: #e6edf3;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding-top: 180px;
      margin: 0;
    }
    h1 { color: #000000; margin: 6px 0 10px; }
    .status { margin-bottom: 8px; font-size: 15px; }
    canvas {
      background-color: #161b22;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      margin-top: 16px;
    }
    #lastValue {
      font-size: 22px;
      font-weight: bold;
      margin-top: 10px;
      color: #000000;
    }
    .logo-fixed {
      position: absolute; top: 10px; left: 10px; width: 120px; z-index: 10;
    }
    .controls-fixed {
      position: absolute; top: 20px; left: 150px; right: 10px; z-index: 11;
      display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap;
    }
    .control-card {
      background: rgba(22,27,34,0.85);
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 10px 12px;
      display: inline-flex; gap: 10px; align-items: center;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    .control-card label { font-size: 14px; color: #c9d1d9; }
    .control-card input[type="number"] {
      width: 120px; padding: 8px 10px; border-radius: 10px;
      border: 1px solid #3b3f44; background: #0d1117; color: #e6edf3; font-size: 16px;
      outline: none;
    }
    .control-card button {
      padding: 8px 14px; border-radius: 10px; border: 1px solid #30363d;
      background: #238636; color: white; font-weight: 600; cursor: pointer;
    }
    .control-card button:disabled { background: #2d333b; cursor: not-allowed; }
    .sent-badge { font-size: 13px; color: #8b949e; }
  </style>
</head>
<body>
  <img class="logo-fixed" 
       src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ed/Escudo_Universidad_Militar_Nueva_Granada.svg/958px-Escudo_Universidad_Militar_Nueva_Granada.svg.png" 
       alt="Logo UMNG">

  <div class="controls-fixed">
    <div class="control-card">
      <label for="refInput">Referencia (Â°):</label>
      <!-- ðŸ”¸ Limitado a -10 a 10 -->
      <input id="refInput" type="number" step="0.1" min="-10" max="10" placeholder="ej. 5.0" inputmode="decimal" />
      <button id="sendBtn" disabled>Enviar</button>
      <span id="lastSent" class="sent-badge">Ãšltimo enviado: --</span>
    </div>
  </div>

  <h1>PÃ‰NDULO CONTROL</h1>
  <div class="status" id="status">Conectando...</div>
  <div id="lastValue">Ãšltimo Î¸: -- Â°</div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script>
    const broker   = "wss://broker.hivemq.com:8884/mqtt";
    const topicSub = "pendulo/esp32/imu";
    const topicPub = "pendulo/esp32/cmd";
    const client   = mqtt.connect(broker);

    const statusEl   = document.getElementById("status");
    const lastValEl  = document.getElementById("lastValue");
    const refInput   = document.getElementById("refInput");
    const sendBtn    = document.getElementById("sendBtn");
    const lastSentEl = document.getElementById("lastSent");

    client.on("connect", () => {
      statusEl.textContent = "ðŸŸ¢ Conectado";
      client.subscribe(topicSub);
      sendBtn.disabled = false;
    });
    client.on("reconnect", () => { statusEl.textContent = "ðŸŸ¡ Reintentando conexiÃ³nâ€¦"; sendBtn.disabled = true; });
    client.on("close", () => { statusEl.textContent = "ðŸŸ  Desconectado"; sendBtn.disabled = true; });
    client.on("error", (err) => { statusEl.textContent = "ðŸ”´ Error: " + err.message; sendBtn.disabled = true; });

    // EnvÃ­o de nÃºmero
    function publishNumber() {
      const raw = refInput.value.trim().replace(",", ".");
      if (raw === "") return;
      const num = parseFloat(raw);
      if (isNaN(num)) { alert("Valor invÃ¡lido."); return; }
      const min = parseFloat(refInput.min), max = parseFloat(refInput.max);
      const clipped = Math.max(min, Math.min(max, num));
      client.publish(topicPub, String(clipped), { qos: 0, retain: true });
      lastSentEl.textContent = `Ãšltimo enviado: ${clipped}`;
    }
    sendBtn.addEventListener("click", publishNumber);
    refInput.addEventListener("keydown", (e) => { if (e.key === "Enter") publishNumber(); });

    // GrÃ¡fico
    const ctx = document.getElementById("chart").getContext("2d");
    const data = { labels: [], datasets: [{ label: "Ãngulo (Â°)", data: [], borderColor: "#58a6ff", borderWidth: 2, pointRadius: 0, fill: false, tension: 0.15 }] };
    const chart = new Chart(ctx, {
      type: "line",
      data: data,
      options: {
        animation: false,
        plugins: { legend: { labels: { color: "#e6edf3" } } },
        scales: {
          x: { title: { display: true, text: "Tiempo (s)", color: "#e6edf3" }, ticks: { color: "#aaa" }, grid: { color: "#30363d" } },
          y: { title: { display: true, text: "Ãngulo (Â°)", color: "#e6edf3" }, min: -50, max: 50, ticks: { color: "#aaa" }, grid: { color: "#30363d" } }
        }
      }
    });
    let t0 = Date.now();
    function updateChart(value) {
      const t = ((Date.now() - t0) / 1000).toFixed(1);
      data.labels.push(t);
      data.datasets[0].data.push(value);
      if (data.labels.length > 150) { data.labels.shift(); data.datasets[0].data.shift(); }
      chart.update("none");
    }

    // RecepciÃ³n MQTT
    client.on("message", (topic, message) => {
      if (topic !== topicSub) return;
      const val = parseFloat(message.toString());
      if (!isNaN(val)) {
        lastValEl.textContent = `Ãšltimo Î¸: ${val.toFixed(2)} Â°`;
        updateChart(val);
      }
    });
  </script>
</body>
</html>
